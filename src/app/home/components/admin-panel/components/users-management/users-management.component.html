<div class="users-management-container">
  @if (employees$ | async; as employees) {
    <div class="table-container">
      <p-table #dt2
               [value]="employees"
               [globalFilterFields]="['fullName', 'role', 'username']">
        <ng-template pTemplate="caption">
          <div class="table-top-service">
            <h2>Список сотрудников</h2>

            <p-iconField iconPosition="left" class="ml-auto">
              <p-inputIcon>
                <i class="fi fi-rr-search"></i>
              </p-inputIcon>
              <input #search
                     pInputText
                     type="text"
                     placeholder="Поиск"
                     (input)="dt2.filterGlobal(search.value, 'contains')"/>
            </p-iconField>
          </div>
        </ng-template>
        <ng-template pTemplate="header">
          <tr>
            <th style="width:50px" class="sticky-left">№ п/п</th>
            <th style="width:20%">Имя пользователя</th>
            <th style="width:20%">ФИО</th>
            <th style="width:20%">Роль</th>
            <th style="width:20%">Статус</th>
            <th style="width:50px" class="sticky-right"></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-employee let-rowIndex="rowIndex">
          <tr>
            <td class="sticky-left">
              {{ rowIndex + 1 }}
            </td>
            <td>
              {{ employee.username }}
            </td>
            <td [pEditableColumn]="employee.fullName" pEditableColumnField="fullName">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText placeholder="Введите ФИО сотрудника"
                         [(ngModel)]="employee.fullName"
                         (change)="userEdit(employee)">
                </ng-template>
                <ng-template pTemplate="output">
                  <span>
                    {{ employee.fullName }}
                  </span>
                </ng-template>
              </p-cellEditor>
            </td>
            <td [pEditableColumn]="employee.role" pEditableColumnField="role">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-dropdown placeholder="Выберите роль"
                              appendTo="body"
                              [overlayOptions]="{styleClass: 'user-menu-table-dropdown-overlay'}"
                              [options]="roles"
                              [(ngModel)]="employee.role"
                              (onChange)="userEdit(employee)">
                  </p-dropdown>
                </ng-template>
                <ng-template pTemplate="output">
                  <span>
                    {{ employee.role }}
                  </span>
                </ng-template>
              </p-cellEditor>
            </td>
            <td [pEditableColumn]="employee.status" pEditableColumnField="status">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-dropdown placeholder="Выберите статус"
                              appendTo="body"
                              optionLabel="label"
                              optionValue="value"
                              [overlayOptions]="{styleClass: 'user-menu-table-dropdown-overlay'}"
                              [options]="employeeStatuses"
                              [(ngModel)]="employee.status"
                              (onChange)="userEdit(employee)">
                  </p-dropdown>
                </ng-template>
                <ng-template pTemplate="output">
                  <span>
                    <p-tag [class]="employee.status">{{ STATUSES[employee.status] }}</p-tag>
                  </span>
                </ng-template>
              </p-cellEditor>
            </td>
            <td style="max-width: 50px" class="sticky-right">
              <button pButton icon="fi fi-rr-trash"
                      severity="secondary"
                      size="large"
                      style="width: 42px; height: 42px"
                      [rounded]="true"
                      [text]="true"
                      (click)="deleteUser(employee)">
              </button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <button pButton (click)="showModal()">Добавить сотрудника</button>
  } @else {
    <app-loading-screen></app-loading-screen>
  }
</div>

<p-dialog class="modal"
          [header]="'Добавление нового сотрудника'"
          [modal]="true"
          [(visible)]="isDialogShow"
          (onHide)="resetForm()">
  <div class="modal-content">
    <div class="form">
      <div class="form-field-wrapper">
        <input pInputText placeholder="Введите Логин для сотрудника" [formControl]="userFormDto.controls.username">
        <small>{{ getErrorMessage(userFormDto.controls.username) }}</small>
      </div>

      <div class="form-field-wrapper">
        <input pInputText placeholder="Введите Пароль для сотрудника" [formControl]="userFormDto.controls.password">
        <small>{{ getErrorMessage(userFormDto.controls.password) }}</small>
      </div>

      <div class="form-field-wrapper">
        <input pInputText placeholder="Введите ФИО сотрудника" [formControl]="userFormDto.controls.fullName">
        <small>{{ getErrorMessage(userFormDto.controls.fullName) }}</small>
      </div>

      <div class="form-field-wrapper">
        <p-dropdown
          placeholder="Выберите роль сотрудника"
          appendTo="body"
          [options]="['User', 'Admin', 'Dining']"
          [formControl]="userFormDto.controls.role"/>
        <small>{{ getErrorMessage(userFormDto.controls.role) }}</small>
      </div>
    </div>

    <div class="modal-service">
      <p-button label="Отмена" severity="secondary" text="true" (click)="isDialogShow = false"/>
      <button pButton (click)="sendForm()" style="min-width: 110px; justify-content: center">
        @if (isLoading$ | async) {
          <p-progressSpinner [style]="{width: '18px', height: '18px'}" strokeWidth="6"></p-progressSpinner>
        } @else {
          Добавить
        }
      </button>
    </div>
  </div>
</p-dialog>
